{% extends "base.html" %}
{% block title %}Basic vs. LLM Analytics — Renewal Review{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
  <h1 style="font-size:20px;">Basic vs. LLM Analytics</h1>
  <button class="btn btn-primary" onclick="runComparison(100)">Compare Sample (100)</button>
</div>

<div id="loading"><div class="spinner"></div><p style="margin-top:8px;">Comparing policies...</p></div>

<div id="result" style="display:none;">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="value" id="sample-size"></div>
      <div class="label">Policies Compared</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#3182ce" id="risk-changes"></div>
      <div class="label">Risk Level Changes</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#805ad5" id="llm-analyzed"></div>
      <div class="label">AI Analyzed</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#d69e2e" id="new-insights"></div>
      <div class="label">New Insights</div>
    </div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
    <div class="card">
      <h2>Basic Analytics</h2>
      <p style="font-size:12px; color:#718096; margin-bottom:8px;" id="basic-time"></p>
      <table>
        <tr><td>No Action Needed</td><td id="basic-no-action-needed"></td></tr>
        <tr><td>Review Recommended</td><td id="basic-review-recommended"></td></tr>
        <tr><td>Action Required</td><td id="basic-action-required"></td></tr>
        <tr><td>Urgent Review</td><td id="basic-urgent-review"></td></tr>
      </table>
    </div>
    <div class="card">
      <h2>LLM Analytics</h2>
      <p style="font-size:12px; color:#718096; margin-bottom:8px;" id="llm-time"></p>
      <table>
        <tr><td>No Action Needed</td><td id="llm-no-action-needed"></td></tr>
        <tr><td>Review Recommended</td><td id="llm-review-recommended"></td></tr>
        <tr><td>Action Required</td><td id="llm-action-required"></td></tr>
        <tr><td>Urgent Review</td><td id="llm-urgent-review"></td></tr>
      </table>
      <p style="font-size:12px; color:#805ad5; margin-top:8px;" id="llm-pct"></p>
    </div>
  </div>

  <div class="card">
    <h2>Comparison</h2>
    <table>
      <tr><td>Risk reassessments</td><td id="delta-risk"></td></tr>
      <tr><td>New AI findings</td><td id="delta-insights"></td></tr>
      <tr><td>Additional time</td><td id="delta-latency"></td></tr>
    </table>
  </div>

  <div class="card" id="examples-section" style="display:none;">
    <h2 style="color:#805ad5;">Risk Changed — Individual Cases <span style="font-weight:400; font-size:12px; color:#718096;" id="examples-count"></span></h2>
    <p style="font-size:12px; color:#718096; margin-bottom:10px;">Policies where LLM analysis changed the risk assessment vs rule-only</p>
    <table>
      <thead>
        <tr>
          <th>Policy #</th>
          <th>Basic Risk</th>
          <th>LLM Risk</th>
          <th>Flags</th>
          <th>LLM Insights</th>
        </tr>
      </thead>
      <tbody id="examples-body"></tbody>
    </table>
    <div id="examples-pager" style="display:none; justify-content:center; align-items:center; gap:12px; margin-top:16px;">
      <button class="btn btn-secondary" style="padding:4px 12px; font-size:12px;" id="examples-prev" onclick="examplesPage(-1)">&larr; Prev</button>
      <span style="font-size:13px; color:#4a5568;" id="examples-page-info"></span>
      <button class="btn btn-secondary" style="padding:4px 12px; font-size:12px;" id="examples-next" onclick="examplesPage(1)">Next &rarr;</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function renderResult(d) {
  document.getElementById('sample-size').textContent = d.sample_size;
  document.getElementById('risk-changes').textContent = d.delta.risk_level_changes;
  document.getElementById('llm-analyzed').textContent = d.llm.llm_analyzed;
  document.getElementById('new-insights').textContent = d.delta.new_llm_insights;

  document.getElementById('basic-time').textContent = (d.basic.processing_time_ms / 1000).toFixed(1) + 's';
  document.getElementById('basic-no-action-needed').textContent = d.basic.distribution.no_action_needed;
  document.getElementById('basic-review-recommended').textContent = d.basic.distribution.review_recommended;
  document.getElementById('basic-action-required').textContent = d.basic.distribution.action_required;
  document.getElementById('basic-urgent-review').textContent = d.basic.distribution.urgent_review;

  document.getElementById('llm-time').textContent = (d.llm.processing_time_ms / 1000).toFixed(1) + 's';
  document.getElementById('llm-no-action-needed').textContent = d.llm.distribution.no_action_needed;
  document.getElementById('llm-review-recommended').textContent = d.llm.distribution.review_recommended;
  document.getElementById('llm-action-required').textContent = d.llm.distribution.action_required;
  document.getElementById('llm-urgent-review').textContent = d.llm.distribution.urgent_review;
  document.getElementById('llm-pct').textContent = d.llm.llm_analyzed_pct + '% policies analyzed by AI';

  document.getElementById('delta-risk').textContent = d.delta.risk_level_changes;
  document.getElementById('delta-insights').textContent = d.delta.new_llm_insights;
  document.getElementById('delta-latency').textContent = (d.delta.latency_overhead_ms / 1000).toFixed(1) + 's';

  allExamples = d.examples || [];
  exCurrentPage = 1;
  renderExamplesPage();
}

var allExamples = [];
var exCurrentPage = 1;
var EX_PAGE_SIZE = 20;

function examplesPage(delta) {
  var totalPages = Math.max(1, Math.ceil(allExamples.length / EX_PAGE_SIZE));
  exCurrentPage = Math.max(1, Math.min(exCurrentPage + delta, totalPages));
  renderExamplesPage();
}

function renderExamplesPage() {
  var section = document.getElementById('examples-section');
  var body = document.getElementById('examples-body');
  body.innerHTML = '';

  if (allExamples.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';

  var totalPages = Math.max(1, Math.ceil(allExamples.length / EX_PAGE_SIZE));
  exCurrentPage = Math.min(exCurrentPage, totalPages);
  var start = (exCurrentPage - 1) * EX_PAGE_SIZE;
  var page = allExamples.slice(start, start + EX_PAGE_SIZE);

  document.getElementById('examples-count').textContent = allExamples.length + ' total — page ' + exCurrentPage + '/' + totalPages;

  page.forEach(function(ex) {
    var flags = ex.flags.map(function(f) { return '<span class="flag-tag">'+f+'</span>'; }).join(' ');
    var insights = '—';
    if (ex.llm_insights && ex.llm_insights.length > 0) {
      insights = ex.llm_insights.map(function(i) {
        return '<span class="flag-tag" style="background:#e9d8fd;color:#553c9a;">'+i.type+'</span> ' +
          i.finding + ' <span style="font-size:11px;color:#718096;">('+Math.round(i.confidence*100)+'%)</span>';
      }).join('<br>');
    }
    body.innerHTML += '<tr>' +
      '<td style="font-weight:500;"><a href="/ui/review/'+ex.policy_number+'" style="color:#3182ce;">'+ex.policy_number+'</a></td>' +
      '<td><span class="badge badge-'+ex.basic_risk+'">'+ex.basic_risk+'</span></td>' +
      '<td><span class="badge badge-'+ex.llm_risk+'">'+ex.llm_risk+'</span></td>' +
      '<td>'+flags+'</td>' +
      '<td style="font-size:12px;">'+insights+'</td>' +
      '</tr>';
  });

  var pager = document.getElementById('examples-pager');
  if (totalPages > 1) {
    pager.style.display = 'flex';
    document.getElementById('examples-prev').style.visibility = exCurrentPage > 1 ? 'visible' : 'hidden';
    document.getElementById('examples-next').style.visibility = exCurrentPage < totalPages ? 'visible' : 'hidden';
    document.getElementById('examples-page-info').textContent = exCurrentPage + ' / ' + totalPages;
  } else {
    pager.style.display = 'none';
  }
}

async function runComparison(sample) {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('result').style.display = 'none';

  const resp = await fetch('/migration/comparison?sample='+sample, {method:'POST'});
  const job = await resp.json();

  if (job.job_id) {
    while (true) {
      await new Promise(r => setTimeout(r, 300));
      const status = await fetch('/migration/status/' + job.job_id).then(r => r.json());
      if (status.status === 'completed' && status.result) {
        renderResult(status.result);
        break;
      }
      if (status.status === 'failed') {
        document.getElementById('loading').innerHTML = '<p style="color:#e53e3e;">Failed: ' + (status.error || 'unknown') + '</p>';
        return;
      }
    }
  }

  document.getElementById('loading').style.display = 'none';
  document.getElementById('result').style.display = 'block';
}
</script>
{% endblock %}
