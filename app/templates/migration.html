{% extends "base.html" %}
{% block title %}V1 vs V2 Migration — Renewal Review{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
  <h1 style="font-size:20px;">V1 vs V2 Migration Comparison</h1>
  <div style="display:flex; gap:8px;">
    <button class="btn btn-primary" onclick="runComparison(50)">Compare (50)</button>
    <button class="btn btn-secondary" onclick="runComparison(200)">Compare (200)</button>
  </div>
</div>

<div id="loading"><div class="spinner"></div><p style="margin-top:8px;">Running comparison...</p></div>

<div id="result" style="display:none;">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="value" id="sample-size"></div>
      <div class="label">Sample Size</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#3182ce" id="risk-changes"></div>
      <div class="label">Risk Level Changes</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#805ad5" id="llm-analyzed"></div>
      <div class="label">LLM Analyzed</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#d69e2e" id="new-insights"></div>
      <div class="label">New Insights</div>
    </div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
    <div class="card">
      <h2>V1 — Rule-Based</h2>
      <p style="font-size:12px; color:#718096; margin-bottom:8px;" id="v1-time"></p>
      <table>
        <tr><td>Low</td><td id="v1-low"></td></tr>
        <tr><td>Medium</td><td id="v1-medium"></td></tr>
        <tr><td>High</td><td id="v1-high"></td></tr>
        <tr><td>Critical</td><td id="v1-critical"></td></tr>
      </table>
    </div>
    <div class="card">
      <h2>V2 — LLM Hybrid</h2>
      <p style="font-size:12px; color:#718096; margin-bottom:8px;" id="v2-time"></p>
      <table>
        <tr><td>Low</td><td id="v2-low"></td></tr>
        <tr><td>Medium</td><td id="v2-medium"></td></tr>
        <tr><td>High</td><td id="v2-high"></td></tr>
        <tr><td>Critical</td><td id="v2-critical"></td></tr>
      </table>
      <p style="font-size:12px; color:#805ad5; margin-top:8px;" id="v2-llm-pct"></p>
    </div>
  </div>

  <div class="card">
    <h2>Delta</h2>
    <table>
      <tr><td>Risk level changes</td><td id="delta-risk"></td></tr>
      <tr><td>New LLM insights</td><td id="delta-insights"></td></tr>
      <tr><td>Latency overhead</td><td id="delta-latency"></td></tr>
    </table>
  </div>

  <div class="card" id="examples-section" style="display:none;">
    <h2 style="color:#805ad5;">Risk Changed — Individual Cases</h2>
    <p style="font-size:12px; color:#718096; margin-bottom:10px;">Policies where LLM analysis changed the risk assessment vs rule-only</p>
    <table>
      <thead>
        <tr>
          <th>Policy #</th>
          <th>V1 Risk</th>
          <th>V2 Risk</th>
          <th>Flags</th>
          <th>LLM Insights</th>
        </tr>
      </thead>
      <tbody id="examples-body"></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function renderResult(d) {
  document.getElementById('sample-size').textContent = d.sample_size;
  document.getElementById('risk-changes').textContent = d.delta.risk_level_changes;
  document.getElementById('llm-analyzed').textContent = d.v2.llm_analyzed;
  document.getElementById('new-insights').textContent = d.delta.new_llm_insights;

  document.getElementById('v1-time').textContent = d.v1.processing_time_ms + ' ms';
  document.getElementById('v1-low').textContent = d.v1.distribution.low;
  document.getElementById('v1-medium').textContent = d.v1.distribution.medium;
  document.getElementById('v1-high').textContent = d.v1.distribution.high;
  document.getElementById('v1-critical').textContent = d.v1.distribution.critical;

  document.getElementById('v2-time').textContent = d.v2.processing_time_ms + ' ms';
  document.getElementById('v2-low').textContent = d.v2.distribution.low;
  document.getElementById('v2-medium').textContent = d.v2.distribution.medium;
  document.getElementById('v2-high').textContent = d.v2.distribution.high;
  document.getElementById('v2-critical').textContent = d.v2.distribution.critical;
  document.getElementById('v2-llm-pct').textContent = d.v2.llm_analyzed_pct + '% policies analyzed by LLM';

  document.getElementById('delta-risk').textContent = d.delta.risk_level_changes;
  document.getElementById('delta-insights').textContent = d.delta.new_llm_insights;
  document.getElementById('delta-latency').textContent = d.delta.latency_overhead_ms + ' ms';

  const body = document.getElementById('examples-body');
  body.innerHTML = '';
  if (d.examples && d.examples.length > 0) {
    document.getElementById('examples-section').style.display = 'block';
    d.examples.forEach(ex => {
      const flags = ex.flags.map(f => '<span class="flag-tag">'+f+'</span>').join(' ');
      let insights = '—';
      if (ex.v2_insights && ex.v2_insights.length > 0) {
        insights = ex.v2_insights.map(i =>
          '<span class="flag-tag" style="background:#e9d8fd;color:#553c9a;">'+i.type+'</span> ' +
          i.finding + ' <span style="font-size:11px;color:#718096;">('+Math.round(i.confidence*100)+'%)</span>'
        ).join('<br>');
      }
      body.innerHTML += '<tr>' +
        '<td style="font-weight:500;"><a href="/ui/review/'+ex.policy_number+'" style="color:#3182ce;">'+ex.policy_number+'</a></td>' +
        '<td><span class="badge badge-'+ex.v1_risk+'">'+ex.v1_risk+'</span></td>' +
        '<td><span class="badge badge-'+ex.v2_risk+'">'+ex.v2_risk+'</span></td>' +
        '<td>'+flags+'</td>' +
        '<td style="font-size:12px;">'+insights+'</td>' +
        '</tr>';
    });
  } else {
    document.getElementById('examples-section').style.display = 'none';
  }
}

async function runComparison(sample) {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('result').style.display = 'none';

  const resp = await fetch('/migration/comparison?sample='+sample, {method:'POST'});
  const job = await resp.json();

  if (job.job_id) {
    while (true) {
      await new Promise(r => setTimeout(r, 300));
      const status = await fetch('/migration/status/' + job.job_id).then(r => r.json());
      if (status.status === 'completed' && status.result) {
        renderResult(status.result);
        break;
      }
      if (status.status === 'failed') {
        document.getElementById('loading').innerHTML = '<p style="color:#e53e3e;">Failed: ' + (status.error || 'unknown') + '</p>';
        return;
      }
    }
  }

  document.getElementById('loading').style.display = 'none';
  document.getElementById('result').style.display = 'block';
}
</script>
{% endblock %}
