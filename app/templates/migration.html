{% extends "base.html" %}
{% block title %}Basic vs. LLM Analytics — Renewal Review{% endblock %}

{% block content %}
<style>
  .progress-container { background:#edf2f7; border-radius:8px; overflow:hidden; height:24px; position:relative; }
  .progress-bar { height:100%; background:linear-gradient(90deg, #805ad5, #6b46c1); border-radius:8px; transition:width 0.3s ease; min-width:0; }
  .progress-text { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; color:#2d3748; }
  .results-table td, .results-table th { font-size:12px; }
  .risk-changed-row { background:#faf5ff; }
</style>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
  <h1 style="font-size:20px;">LLM Insights</h1>
  <button class="btn btn-primary" id="compare-btn" onclick="runComparison()">Compare</button>
</div>

<div class="card" style="margin-bottom:16px; background:#faf5ff; border-left:4px solid #805ad5;">
  <p style="font-size:13px; color:#553c9a; margin-bottom:6px; font-weight:600;">Reviewed + Review Recommended policies only</p>
  <p style="font-size:12px; color:#718096; line-height:1.6;">
    LLM analysis targets policies that have been <strong>reviewed</strong> and classified as <strong>Review Recommended</strong>
    — those flagged by rules but not yet critical.
    The AI re-evaluates risk using context that rules alone cannot capture (e.g., notes, claim patterns, coverage gaps).
  </p>
  <p style="font-size:12px; color:#805ad5; line-height:1.6; margin-top:6px;">
    <strong>Production:</strong> All reviewed Review Recommended policies are analyzed via LLM API.
    <br><strong>Demo:</strong> Random sample of up to 100 policies to manage API costs.
  </p>
</div>

<div id="loading" style="display:none; max-width:480px; margin:0 auto; text-align:center;">
  <p style="margin-bottom:8px; font-size:13px; color:#553c9a; font-weight:500;" id="loading-msg">Comparing policies with AI...</p>
  <div class="progress-container">
    <div class="progress-bar" id="progress-bar" style="width:0%;"></div>
    <div class="progress-text" id="progress-text">0%</div>
  </div>
  <p style="font-size:12px; color:#718096; margin-top:6px;" id="progress-detail"></p>
</div>

<div id="result" style="display:none;">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="value" id="sample-size"></div>
      <div class="label">Policies Compared</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#3182ce" id="risk-changes"></div>
      <div class="label">Risk Level Changes</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#805ad5" id="llm-analyzed"></div>
      <div class="label">Policies with Insights</div>
    </div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
    <div class="card">
      <h2>Basic Analytics</h2>
      <p style="font-size:12px; color:#718096; margin-bottom:8px;" id="basic-time"></p>
      <table>
        <tr><td>No Action Needed</td><td id="basic-no-action-needed"></td></tr>
        <tr><td>Review Recommended</td><td id="basic-review-recommended"></td></tr>
        <tr><td>Action Required</td><td id="basic-action-required"></td></tr>
        <tr><td>Urgent Review</td><td id="basic-urgent-review"></td></tr>
      </table>
    </div>
    <div class="card">
      <h2>LLM Analytics</h2>
      <p style="font-size:12px; color:#718096; margin-bottom:8px;" id="llm-time"></p>
      <table>
        <tr><td>No Action Needed</td><td id="llm-no-action-needed"></td></tr>
        <tr><td>Review Recommended</td><td id="llm-review-recommended"></td></tr>
        <tr><td>Action Required</td><td id="llm-action-required"></td></tr>
        <tr><td>Urgent Review</td><td id="llm-urgent-review"></td></tr>
      </table>
      <p style="font-size:12px; color:#805ad5; margin-top:8px;" id="llm-pct"></p>
    </div>
  </div>

  <div class="card" id="all-results-section" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <div>
        <h2 style="display:inline;">All Compared Policies</h2>
        <span style="font-weight:400; font-size:12px; color:#718096; margin-left:8px;" id="all-results-count"></span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="font-size:12px; color:#718096; display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" id="filter-risk-changed" onchange="filterAllResults()">
          Risk changed only
        </label>
        <label style="font-size:12px; color:#718096; display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" id="filter-with-insights" onchange="filterAllResults()">
          With insights only
        </label>
      </div>
    </div>
    <p style="font-size:12px; color:#718096; margin-bottom:10px;">
      All policies compared in this run. <span style="background:#faf5ff; padding:2px 6px; border-radius:3px; color:#805ad5;">Purple rows</span> = risk level changed by LLM.
    </p>
    <table class="results-table">
      <thead>
        <tr>
          <th>Policy #</th>
          <th>Rule Risk</th>
          <th>LLM Risk</th>
          <th>Flags</th>
          <th>LLM</th>
        </tr>
      </thead>
      <tbody id="all-results-body"></tbody>
    </table>
    <div id="all-results-pager" style="display:none; justify-content:center; align-items:center; gap:12px; margin-top:16px;">
      <button class="btn btn-secondary" style="padding:4px 12px; font-size:12px;" id="all-prev" onclick="allResultsPage(-1)">&larr; Prev</button>
      <span style="font-size:13px; color:#4a5568;" id="all-page-info"></span>
      <button class="btn btn-secondary" style="padding:4px 12px; font-size:12px;" id="all-next" onclick="allResultsPage(1)">Next &rarr;</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var allCompared = [];
var filteredCompared = [];
var allCurrentPage = 1;
var ALL_PAGE_SIZE = 20;

function renderResult(d) {
  var sizeText = d.total_eligible && d.total_eligible > d.sample_size
    ? d.sample_size + ' / ' + d.total_eligible
    : String(d.sample_size);
  document.getElementById('sample-size').textContent = sizeText;
  document.getElementById('risk-changes').textContent = d.delta.risk_level_changes;
  document.getElementById('llm-analyzed').textContent = d.llm.llm_analyzed;

  document.getElementById('basic-time').textContent = (d.basic.processing_time_ms / 1000).toFixed(1) + 's';
  document.getElementById('basic-no-action-needed').textContent = d.basic.distribution.no_action_needed;
  document.getElementById('basic-review-recommended').textContent = d.basic.distribution.review_recommended;
  document.getElementById('basic-action-required').textContent = d.basic.distribution.action_required;
  document.getElementById('basic-urgent-review').textContent = d.basic.distribution.urgent_review;

  document.getElementById('llm-time').textContent = (d.llm.processing_time_ms / 1000).toFixed(1) + 's';
  document.getElementById('llm-no-action-needed').textContent = d.llm.distribution.no_action_needed;
  document.getElementById('llm-review-recommended').textContent = d.llm.distribution.review_recommended;
  document.getElementById('llm-action-required').textContent = d.llm.distribution.action_required;
  document.getElementById('llm-urgent-review').textContent = d.llm.distribution.urgent_review;
  document.getElementById('llm-pct').textContent = d.llm.llm_analyzed_pct + '% policies analyzed by AI';

  allCompared = d.all_compared || d.examples || [];
  allCurrentPage = 1;
  document.getElementById('filter-risk-changed').checked = false;
  filterAllResults();

  document.getElementById('result').style.display = 'block';
}

function filterAllResults() {
  var onlyChanged = document.getElementById('filter-risk-changed').checked;
  var onlyInsights = document.getElementById('filter-with-insights').checked;
  filteredCompared = allCompared.filter(function(r) {
    if (onlyChanged && !r.risk_changed) return false;
    if (onlyInsights && !(r.llm_insights && r.llm_insights.length > 0)) return false;
    return true;
  });
  allCurrentPage = 1;
  renderAllResultsPage();
}

function allResultsPage(delta) {
  var totalPages = Math.max(1, Math.ceil(filteredCompared.length / ALL_PAGE_SIZE));
  allCurrentPage = Math.max(1, Math.min(allCurrentPage + delta, totalPages));
  renderAllResultsPage();
}

function renderAllResultsPage() {
  var section = document.getElementById('all-results-section');
  var body = document.getElementById('all-results-body');
  body.innerHTML = '';

  if (allCompared.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';

  var totalPages = Math.max(1, Math.ceil(filteredCompared.length / ALL_PAGE_SIZE));
  allCurrentPage = Math.min(allCurrentPage, totalPages);
  var start = (allCurrentPage - 1) * ALL_PAGE_SIZE;
  var page = filteredCompared.slice(start, start + ALL_PAGE_SIZE);

  var countText = filteredCompared.length + ' policies';
  if (filteredCompared.length < allCompared.length) countText += ' (filtered from ' + allCompared.length + ')';
  countText += ' — page ' + allCurrentPage + '/' + totalPages;
  document.getElementById('all-results-count').textContent = countText;

  page.forEach(function(r) {
    var rowClass = r.risk_changed ? ' class="risk-changed-row"' : '';
    var flags = (r.flags || []).map(function(f) { return '<span class="flag-tag">'+getLabel(f)+'</span>'; }).join(' ');

    var riskArrow = r.risk_changed ? ' &rarr; ' : ' = ';

    body.innerHTML += '<tr' + rowClass + '>' +
      '<td style="font-weight:500;"><a href="/ui/review/'+r.policy_number+'?ref=insight" style="color:#3182ce;">'+r.policy_number+'</a></td>' +
      '<td><span class="badge badge-'+r.basic_risk+'">'+getLabel(r.basic_risk)+'</span></td>' +
      '<td><span class="badge badge-'+r.llm_risk+'">'+getLabel(r.llm_risk)+'</span>' +
      (r.risk_changed ? ' <span style="font-size:10px; color:#805ad5; font-weight:600;">CHANGED</span>' : '') + '</td>' +
      '<td>'+flags+'</td>' +
      '<td>'+(r.llm_insights && r.llm_insights.length > 0 ? '<span class="llm-sparkle" title="LLM analyzed"></span>' : '')+'</td>' +
      '</tr>';
  });

  var pager = document.getElementById('all-results-pager');
  if (totalPages > 1) {
    pager.style.display = 'flex';
    document.getElementById('all-prev').style.visibility = allCurrentPage > 1 ? 'visible' : 'hidden';
    document.getElementById('all-next').style.visibility = allCurrentPage < totalPages ? 'visible' : 'hidden';
    document.getElementById('all-page-info').textContent = allCurrentPage + ' / ' + totalPages;
  } else {
    pager.style.display = 'none';
  }
}

var progressStartTime = 0;
var currentPhase = '';

function updateProgress(processed, total, phase) {
  if (phase !== currentPhase) {
    progressStartTime = Date.now();
    currentPhase = phase;
  }
  var pct = total > 0 ? Math.round((processed / total) * 100) : 0;
  document.getElementById('progress-bar').style.width = pct + '%';
  document.getElementById('progress-text').textContent = pct + '%';

  var phaseLabel = phase === 'llm' ? 'LLM analysis' : 'Rule-based analysis';
  var elapsed = (Date.now() - progressStartTime) / 1000;
  var detail = phaseLabel + ': ' + processed + ' / ' + total + ' policies';

  if (processed > 0 && pct < 100) {
    var rate = processed / elapsed;
    var remaining = (total - processed) / rate;
    if (remaining < 60) {
      detail += ' (~' + Math.ceil(remaining) + 's remaining)';
    } else {
      detail += ' (~' + Math.ceil(remaining / 60) + 'min remaining)';
    }
  }
  document.getElementById('progress-detail').textContent = detail;
}

async function runComparison() {
  var loading = document.getElementById('loading');
  var resultDiv = document.getElementById('result');
  loading.style.display = 'block';
  resultDiv.style.display = 'none';
  document.getElementById('compare-btn').disabled = true;
  document.getElementById('compare-btn').textContent = 'Comparing...';
  document.getElementById('loading-msg').textContent = 'Comparing policies with AI...';
  document.getElementById('progress-bar').style.width = '0%';
  document.getElementById('progress-text').textContent = '0%';
  document.getElementById('progress-detail').textContent = '';
  progressStartTime = Date.now();
  currentPhase = '';

  const resp = await fetch('/migration/comparison', {method:'POST'});
  if (!resp.ok) {
    var err = await resp.json();
    loading.innerHTML = '<p style="color:#e53e3e;">' + (err.detail || 'Failed') + '</p>';
    document.getElementById('compare-btn').disabled = false;
    document.getElementById('compare-btn').textContent = 'Compare';
    return;
  }
  const job = await resp.json();

  if (job.total) updateProgress(0, job.total, 'basic');

  if (job.job_id) {
    while (true) {
      await new Promise(r => setTimeout(r, 300));
      const status = await fetch('/migration/status/' + job.job_id).then(r => r.json());

      if (status.processed !== undefined && status.total) {
        updateProgress(status.processed, status.total, status.phase || 'basic');
      }

      if (status.status === 'completed' && status.result) {
        updateProgress(status.total, status.total, 'done');
        renderResult(status.result);
        break;
      }
      if (status.status === 'failed') {
        loading.innerHTML = '<p style="color:#e53e3e;">Failed: ' + (status.error || 'unknown') + '</p>';
        document.getElementById('compare-btn').disabled = false;
        document.getElementById('compare-btn').textContent = 'Compare';
        return;
      }
    }
  }

  loading.style.display = 'none';
  document.getElementById('compare-btn').disabled = false;
  document.getElementById('compare-btn').textContent = 'Re-Compare';
}

// Load persisted comparison result on page load
(async function() {
  try {
    var resp = await fetch('/migration/latest');
    if (!resp.ok) return;
    var data = await resp.json();
    if (data.status === 'none') return;
    renderResult(data);
  } catch (e) {}
})();
</script>
{% endblock %}
