{% extends "base.html" %}
{% block title %}Quotes — Renewal Review{% endblock %}

{% block content %}
<style>
  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; }
  .modal-overlay.open { display:flex; align-items:center; justify-content:center; }
  .modal { background:#fff; border-radius:12px; max-width:740px; width:92%; max-height:85vh; overflow-y:auto; padding:28px; position:relative; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
  .modal-close { position:absolute; top:12px; right:16px; background:none; border:none; font-size:20px; cursor:pointer; color:#718096; padding:4px 8px; }
  .modal-close:hover { color:#1a1a2e; }
  .modal h2 { font-size:18px; margin-bottom:8px; padding-right:32px; }
  .modal-premium { font-size:13px; color:#718096; margin-bottom:20px; }
  .quote-card { border:1px solid #e2e8f0; border-radius:10px; padding:20px; margin-bottom:16px; }
  .quote-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:4px; }
  .quote-title { font-weight:700; font-size:15px; color:#2d3748; }
  .quote-subtitle { font-size:12px; color:#718096; margin-bottom:14px; }
  .quote-savings-box { text-align:right; }
  .quote-savings-pct { font-size:22px; font-weight:700; color:#22543d; }
  .quote-savings-dollar { font-size:12px; color:#22543d; }
  .adjustment-row { display:flex; align-items:center; gap:12px; padding:10px 14px; background:#f7fafc; border-radius:6px; margin-bottom:8px; }
  .adj-label { font-size:13px; font-weight:600; color:#2d3748; min-width:180px; }
  .adj-values { display:flex; align-items:center; gap:8px; font-size:13px; }
  .adj-old { color:#9b2c2c; text-decoration:line-through; }
  .adj-arrow { color:#a0aec0; }
  .adj-new { color:#22543d; font-weight:600; }
  .adj-explain { font-size:11px; color:#718096; margin-top:2px; }
  .quote-tradeoff { margin-top:14px; font-size:12px; color:#744210; background:#fefcbf; padding:10px 14px; border-radius:6px; line-height:1.5; }
  .quote-tradeoff strong { display:block; margin-bottom:2px; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; }
  .quote-tip { margin-top:8px; font-size:12px; color:#2b6cb0; background:#ebf8ff; padding:10px 14px; border-radius:6px; line-height:1.5; }
  .quote-tip strong { display:block; margin-bottom:2px; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; }
  .modal-spinner { text-align:center; padding:32px; color:#718096; }
  .total-savings { background:#f0fff4; border:2px solid #c6f6d5; border-radius:10px; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; }
  .total-savings-label { font-size:14px; font-weight:600; color:#22543d; }
  .total-savings-value { font-size:24px; font-weight:700; color:#22543d; }
  .total-savings-detail { font-size:12px; color:#38a169; }
</style>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
  <h1 style="font-size:20px;">Quote Generator</h1>
</div>

{% if not flagged_results %}
<div class="card">
  <p style="color:#718096; text-align:center; padding:24px;">No flagged policies found. Run a batch review from the Dashboard first.</p>
</div>
{% else %}
<div class="card">
  <h2>Flagged Policies <span style="font-weight:400; font-size:12px; color:#718096;">{{ total_flagged }} total — page {{ page }}/{{ total_pages }}</span></h2>
  <table>
    <thead>
      <tr><th>Policy #</th><th>Type</th><th>Premium</th><th>Risk</th><th>Flags</th><th></th></tr>
    </thead>
    <tbody>
      {% for r in flagged_results %}
      <tr>
        <td><a href="/ui/review/{{ r.policy_number }}?ref=quotes">{{ r.policy_number }}</a></td>
        <td>{{ r.pair.prior.policy_type.value if r.pair else "—" }}</td>
        <td>${{ "%.2f"|format(r.pair.renewal.premium) if r.pair else "—" }}</td>
        <td><span class="badge badge-{{ r.risk_level.value }}">{{ r.risk_level.value }}</span></td>
        <td>{% for f in r.diff.flags %}<span class="flag-tag">{{ f.value }}</span>{% endfor %}</td>
        <td><button class="btn btn-primary" style="padding:4px 12px; font-size:12px;" onclick="generateQuotes('{{ r.policy_number }}')">Generate</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if total_pages > 1 %}
  <div style="display:flex; justify-content:center; align-items:center; gap:12px; margin-top:16px;">
    {% if page > 1 %}
    <a href="/ui/quotes?page={{ page - 1 }}" class="btn btn-secondary" style="padding:4px 12px; font-size:12px;">&larr; Prev</a>
    {% endif %}
    <span style="font-size:13px; color:#4a5568;">{{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
    <a href="/ui/quotes?page={{ page + 1 }}" class="btn btn-secondary" style="padding:4px 12px; font-size:12px;">Next &rarr;</a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endif %}

<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <h2 id="modal-title">Quotes</h2>
    <p class="modal-premium" id="modal-premium"></p>
    <div class="modal-spinner" id="modal-loading"><div class="spinner"></div><p style="margin-top:8px;">Generating quotes...</p></div>
    <div id="modal-empty" style="display:none; color:#718096; text-align:center; padding:16px;">No alternative quotes available for this policy.</div>
    <div id="modal-quotes"></div>
    <div id="modal-total" style="display:none;"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var FIELD_LABELS = {
  collision_deductible: 'Collision Deductible',
  comprehensive_deductible: 'Comprehensive Deductible',
  rental_reimbursement: 'Rental Reimbursement',
  roadside_assistance: 'Roadside Assistance',
  medical_payments: 'Medical Payments',
  deductible: 'Home Deductible',
  water_backup: 'Water Backup Coverage',
  coverage_c_personal_property: 'Personal Property (Coverage C)'
};

var FIELD_DESCRIPTIONS = {
  collision_deductible: 'Out-of-pocket amount per collision claim',
  comprehensive_deductible: 'Out-of-pocket amount for non-collision claims (theft, weather, animal)',
  rental_reimbursement: 'Covers rental car costs while vehicle is being repaired',
  roadside_assistance: 'Emergency services: towing, battery jump, flat tire, lockout',
  medical_payments: 'Covers medical expenses regardless of fault',
  deductible: 'Out-of-pocket amount per home insurance claim',
  water_backup: 'Covers damage from sewer/drain backup or sump overflow',
  coverage_c_personal_property: 'Covers personal belongings inside the home'
};

var STRATEGY_LABELS = {
  raise_deductible: 'Raise Deductible',
  drop_optional: 'Drop Optional Coverage',
  reduce_medical: 'Reduce Medical Payments',
  drop_water_backup: 'Drop Water Backup',
  reduce_personal_property: 'Reduce Personal Property'
};

var STRATEGY_DESCRIPTIONS = {
  raise_deductible: 'Increasing the per-claim out-of-pocket amount lowers premium. The client pays more only when a claim occurs.',
  drop_optional: 'Removing convenience coverages that can be replaced with third-party services (e.g., AAA) or self-funded.',
  reduce_medical: 'Lowering medical payment limits. Consider if the client already has adequate health insurance.',
  drop_water_backup: 'Removing sewer/drain backup coverage. Evaluate based on property age, plumbing condition, and local flood risk.',
  reduce_personal_property: 'Reducing personal property coverage to 50% of dwelling value. Review the client\'s actual belongings inventory.'
};

var STRATEGY_TIPS = {
  raise_deductible: 'Recommended for clients with low claim history and emergency savings above the proposed deductible.',
  drop_optional: 'Suitable for newer vehicles under manufacturer warranty, or clients with existing AAA/roadside membership.',
  reduce_medical: 'Best for clients with comprehensive health insurance that already covers auto-related injuries.',
  drop_water_backup: 'Avoid removing for older properties or areas with known drainage issues. Low-risk for newer construction on high ground.',
  reduce_personal_property: 'Ask the client to do a quick home inventory. If total belongings value is well under the proposed limit, this is safe.'
};

var BOOLEAN_FIELDS = ['rental_reimbursement', 'roadside_assistance', 'water_backup', 'replacement_cost'];

function formatValue(field, val) {
  if (BOOLEAN_FIELDS.indexOf(field) !== -1) {
    return val === 'True' ? 'Included' : 'Not Included';
  }
  var num = parseFloat(val);
  if (!isNaN(num) && val !== 'True' && val !== 'False') {
    return '$' + num.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
  }
  return val;
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('open');
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal();
});

async function generateQuotes(policyNumber) {
  try {
    var overlay = document.getElementById('modal-overlay');
    var loading = document.getElementById('modal-loading');
    var quotesEl = document.getElementById('modal-quotes');
    var emptyEl = document.getElementById('modal-empty');
    var totalEl = document.getElementById('modal-total');
    var premiumEl = document.getElementById('modal-premium');

    document.getElementById('modal-title').textContent = 'Alternative Quotes — ' + policyNumber;
    premiumEl.textContent = '';
    loading.style.display = 'block';
    quotesEl.innerHTML = '';
    emptyEl.style.display = 'none';
    totalEl.style.display = 'none';
    overlay.classList.add('open');

    var reviewResp = await fetch('/reviews/' + policyNumber);
    if (!reviewResp.ok) {
      loading.style.display = 'none';
      emptyEl.style.display = 'block';
      emptyEl.textContent = 'Could not fetch review for ' + policyNumber;
      return;
    }
    var review = await reviewResp.json();
    var premium = review.pair.renewal.premium;
    var policyType = review.pair.prior.policy_type;
    premiumEl.textContent = 'Current renewal premium: $' + premium.toLocaleString('en-US', {minimumFractionDigits: 2}) + ' | Type: ' + policyType.toUpperCase();

    var quotesResp = await fetch('/quotes/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(review.pair)
    });
    loading.style.display = 'none';

    if (!quotesResp.ok) {
      emptyEl.style.display = 'block';
      emptyEl.textContent = 'Quote generation failed';
      return;
    }

    var quotes = await quotesResp.json();
    if (quotes.length === 0) {
      emptyEl.style.display = 'block';
      emptyEl.textContent = 'No alternative quotes available — coverages are already optimized for this policy.';
      return;
    }

    var html = '';
    var totalSavingsDollar = 0;
    var totalSavingsPct = 0;

    quotes.forEach(function(q) {
      var strategy = q.adjustments.length > 0 ? q.adjustments[0].strategy : '';
      totalSavingsDollar += q.estimated_savings_dollar;
      totalSavingsPct += q.estimated_savings_pct;

      html += '<div class="quote-card">';

      html += '<div class="quote-header">';
      html += '<div><span class="quote-title">' + q.quote_id + ' — ' + (STRATEGY_LABELS[strategy] || strategy) + '</span></div>';
      html += '<div class="quote-savings-box">';
      html += '<div class="quote-savings-pct">-' + q.estimated_savings_pct + '%</div>';
      html += '<div class="quote-savings-dollar">Save $' + q.estimated_savings_dollar.toFixed(2) + '/yr</div>';
      html += '</div>';
      html += '</div>';

      html += '<div class="quote-subtitle">' + (STRATEGY_DESCRIPTIONS[strategy] || '') + '</div>';

      q.adjustments.forEach(function(a) {
        var label = FIELD_LABELS[a.field] || a.field;
        var desc = FIELD_DESCRIPTIONS[a.field] || '';
        var oldVal = formatValue(a.field, a.original_value);
        var newVal = formatValue(a.field, a.proposed_value);

        html += '<div class="adjustment-row">';
        html += '<div style="flex:1;"><div class="adj-label">' + label + '</div>';
        if (desc) html += '<div class="adj-explain">' + desc + '</div>';
        html += '</div>';
        html += '<div class="adj-values">';
        html += '<span class="adj-old">' + oldVal + '</span>';
        html += '<span class="adj-arrow">&rarr;</span>';
        html += '<span class="adj-new">' + newVal + '</span>';
        html += '</div>';
        html += '</div>';
      });

      html += '<div class="quote-tradeoff"><strong>Trade-off</strong>' + q.trade_off + '</div>';
      var tip = q.broker_tip || STRATEGY_TIPS[strategy] || '';
      if (tip) {
        html += '<div class="quote-tip"><strong>Broker Tip</strong>' + tip + '</div>';
      }

      html += '</div>';
    });
    quotesEl.innerHTML = html;

    if (quotes.length > 1) {
      totalEl.style.display = 'block';
      totalEl.innerHTML = '<div class="total-savings">' +
        '<div><div class="total-savings-label">Combined Savings (all ' + quotes.length + ' options)</div>' +
        '<div class="total-savings-detail">If all recommendations are applied together</div></div>' +
        '<div class="total-savings-value">-' + totalSavingsPct.toFixed(1) + '% ($' + totalSavingsDollar.toFixed(2) + '/yr)</div>' +
        '</div>';
    }
  } catch (e) {
    document.getElementById('modal-loading').style.display = 'none';
    document.getElementById('modal-empty').style.display = 'block';
    document.getElementById('modal-empty').textContent = 'Error: ' + e.message;
  }
}
</script>
{% endblock %}
