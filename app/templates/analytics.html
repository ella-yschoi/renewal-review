{% extends "base.html" %}
{% block title %}Analytics â€” Renewal Review{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
  <h1 style="font-size:20px;">Analytics</h1>
  <button class="btn btn-secondary" onclick="loadAnalytics()">Refresh</button>
</div>

<div id="empty-state" class="card" style="text-align:center; padding:40px; {% if history %}display:none{% endif %}">
  <p style="color:#718096; font-size:14px;">No review data yet. Run a review from the <a href="/">Dashboard</a> to see analytics.</p>
</div>

<div id="analytics-content" style="{% if not history %}display:none{% endif %}">
  <!-- Summary Stats -->
  <div class="stats-grid" id="summary-stats">
    <div class="stat-card">
      <div class="value" id="stat-runs">{{ summary.total_runs }}</div>
      <div class="label">Total Reviews</div>
    </div>
    <div class="stat-card">
      <div class="value" id="stat-policies">{{ summary.total_policies_reviewed }}</div>
      <div class="label">Policies Reviewed</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#9b2c2c" id="stat-urgent">{{ summary.risk_distribution.urgent_review }}</div>
      <div class="label">Urgent Total</div>
    </div>
  </div>

  <!-- Broker Metrics -->
  <div class="card">
    <h2>Broker Workflow</h2>
    {% set bt = broker.total if broker.total else 1 %}
    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; margin-top:12px;">
      <div>
        <div style="font-size:24px; font-weight:700; color:#c05621;" id="broker-contact-needed">{{ broker.contact_needed }}</div>
        <div style="font-size:12px; color:#718096;">Contact Needed</div>
        <div class="progress-bar" style="margin-top:6px;">
          <div class="progress-fill" id="broker-bar-contact" style="width:{{ (broker.contact_needed / bt * 100) }}%; background:#ed8936;"></div>
        </div>
      </div>
      <div>
        <div style="font-size:24px; font-weight:700; color:#2b6cb0;" id="broker-contacted">{{ broker.contacted }}</div>
        <div style="font-size:12px; color:#718096;">Contacted</div>
        <div class="progress-bar" style="margin-top:6px;">
          <div class="progress-fill" id="broker-bar-contacted" style="width:{{ (broker.contacted / bt * 100) }}%; background:#3182ce;"></div>
        </div>
      </div>
      <div>
        <div style="font-size:24px; font-weight:700; color:#2f855a;" id="broker-quotes">{{ broker.quotes_generated }}</div>
        <div style="font-size:12px; color:#718096;">Quotes Generated</div>
        <div class="progress-bar" style="margin-top:6px;">
          <div class="progress-fill" id="broker-bar-quotes" style="width:{{ (broker.quotes_generated / bt * 100) }}%; background:#48bb78;"></div>
        </div>
      </div>
      <div>
        <div style="font-size:24px; font-weight:700; color:#553c9a;" id="broker-reviewed">{{ broker.reviewed }}</div>
        <div style="font-size:12px; color:#718096;">Reviewed</div>
        <div class="progress-bar" style="margin-top:6px;">
          <div class="progress-fill" id="broker-bar-reviewed" style="width:{{ (broker.reviewed / bt * 100) }}%; background:#805ad5;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Risk Distribution -->
  <div class="card">
    <h2>Risk Overview</h2>
    <div style="display:flex; gap:16px; margin-top:12px;">
      {% for level, color in [("no_action_needed", "#c6f6d5"), ("review_recommended", "#fefcbf"), ("action_required", "#fed7d7"), ("urgent_review", "#9b2c2c")] %}
      <div style="flex:1; text-align:center;">
        <div style="background:#e2e8f0; border-radius:6px; height:120px; position:relative; overflow:hidden;">
          {% set total = summary.risk_distribution.no_action_needed + summary.risk_distribution.review_recommended + summary.risk_distribution.action_required + summary.risk_distribution.urgent_review %}
          {% set count = summary.risk_distribution[level] %}
          {% set pct = (count / total * 100) if total else 0 %}
          <div id="risk-bar-{{ level }}" class="risk-bar" style="
            position:absolute; bottom:0; width:100%; border-radius:0 0 6px 6px;
            height:{{ pct }}%;
            background:{{ color }};
          "></div>
        </div>
        <div style="margin-top:8px;">
          <span class="badge badge-{{ level }}">{{ level|label }}</span>
          <div style="font-size:18px; font-weight:700; margin-top:4px;" id="risk-count-{{ level }}">{{ count }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Trends -->
  {% if summary.trends %}
  <div class="card">
    <h2>Daily Summary</h2>
    <table>
      <thead>
        <tr><th>Date</th><th>Reviews</th><th>Urgent Rate</th></tr>
      </thead>
      <tbody id="trends-body">
        {% for t in summary.trends %}
        <tr>
          <td>{{ t.date }}</td>
          <td>{{ t.total_runs }}</td>
          <td>
            <div style="display:flex; align-items:center; gap:8px;">
              <div class="progress-bar" style="flex:1; height:8px;">
                <div class="progress-fill" style="width:{{ t.urgent_review_ratio * 100 }}%; background:{% if t.urgent_review_ratio > 0.1 %}#9b2c2c{% elif t.urgent_review_ratio > 0.05 %}#e53e3e{% else %}#48bb78{% endif %};"></div>
              </div>
              <span style="font-size:12px; color:#4a5568; min-width:40px;">{{ "%.1f"|format(t.urgent_review_ratio * 100) }}%</span>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Run History -->
  <div class="card">
    <h2>Review History</h2>
    <table>
      <thead>
        <tr><th>Review #</th><th>Total</th><th>No Action</th><th>Review</th><th>Action</th><th>Urgent</th><th>Date</th></tr>
      </thead>
      <tbody id="history-body">
        {% for r in history|reverse %}
        <tr>
          <td style="font-family:monospace; font-size:12px;">{{ r.job_id }}</td>
          <td>{{ r.total }}</td>
          <td><span class="badge badge-no_action_needed">{{ r.no_action_needed }}</span></td>
          <td><span class="badge badge-review_recommended">{{ r.review_recommended }}</span></td>
          <td><span class="badge badge-action_required">{{ r.action_required }}</span></td>
          <td><span class="badge badge-urgent_review">{{ r.urgent_review }}</span></td>
          <td style="font-size:12px; color:#718096;">{{ r.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadAnalytics() {
  const [historyResp, trendsResp, brokerResp] = await Promise.all([
    fetch('/analytics/history'),
    fetch('/analytics/trends'),
    fetch('/analytics/broker')
  ]);
  const history = await historyResp.json();
  const trends = await trendsResp.json();
  const broker = await brokerResp.json();

  if (history.length === 0) {
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('analytics-content').style.display = 'none';
    return;
  }

  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('analytics-content').style.display = 'block';

  document.getElementById('stat-runs').textContent = trends.total_runs;
  document.getElementById('stat-policies').textContent = trends.total_policies_reviewed;
  document.getElementById('stat-urgent').textContent = trends.risk_distribution.urgent_review;

  var bt = broker.total || 1;
  document.getElementById('broker-contact-needed').textContent = broker.contact_needed;
  document.getElementById('broker-contacted').textContent = broker.contacted;
  document.getElementById('broker-quotes').textContent = broker.quotes_generated;
  document.getElementById('broker-reviewed').textContent = broker.reviewed;
  document.getElementById('broker-bar-contact').style.width = (broker.contact_needed/bt*100)+'%';
  document.getElementById('broker-bar-contacted').style.width = (broker.contacted/bt*100)+'%';
  document.getElementById('broker-bar-quotes').style.width = (broker.quotes_generated/bt*100)+'%';
  document.getElementById('broker-bar-reviewed').style.width = (broker.reviewed/bt*100)+'%';

  const rd = trends.risk_distribution;
  const total = rd.no_action_needed + rd.review_recommended + rd.action_required + rd.urgent_review || 1;
  ['no_action_needed','review_recommended','action_required','urgent_review'].forEach(level => {
    const pct = rd[level] / total * 100;
    document.getElementById('risk-bar-' + level).style.height = pct + '%';
    document.getElementById('risk-count-' + level).textContent = rd[level];
  });

  const tbody = document.getElementById('history-body');
  tbody.innerHTML = '';
  history.slice().reverse().forEach(r => {
    const d = new Date(r.created_at);
    const dateStr = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    tbody.innerHTML += '<tr>'+
      '<td style="font-family:monospace;font-size:12px;">'+r.job_id+'</td>'+
      '<td>'+r.total+'</td>'+
      '<td><span class="badge badge-no_action_needed">'+r.no_action_needed+'</span></td>'+
      '<td><span class="badge badge-review_recommended">'+r.review_recommended+'</span></td>'+
      '<td><span class="badge badge-action_required">'+r.action_required+'</span></td>'+
      '<td><span class="badge badge-urgent_review">'+r.urgent_review+'</span></td>'+
      '<td style="font-size:12px;color:#718096;">'+dateStr+'</td>'+
      '</tr>';
  });
}
</script>
{% endblock %}
