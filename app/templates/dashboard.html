{% extends "base.html" %}
{% block title %}Dashboard — Renewal Review{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
  <h1 style="font-size:20px;">Dashboard</h1>
  <div style="display:flex; gap:8px;">
    <button class="btn btn-primary" onclick="runBatch(100)">Run Sample (100)</button>
    <button class="btn btn-secondary" onclick="runBatch()">Run All (8,000)</button>
    <button class="btn btn-secondary" onclick="runEval()">Run Eval</button>
  </div>
</div>

<div id="loading"><div class="spinner"></div><p style="margin-top:8px;" id="loading-text">Processing...</p></div>

<div id="summary-section" style="{% if not summary %}display:none{% endif %}">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="value" id="stat-total">{{ summary.total if summary else 0 }}</div>
      <div class="label">Total Processed</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#22543d" id="stat-low">{{ summary.low if summary else 0 }}</div>
      <div class="label">Low Risk</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#744210" id="stat-medium">{{ summary.medium if summary else 0 }}</div>
      <div class="label">Medium Risk</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#9b2c2c" id="stat-high">{{ summary.high if summary else 0 }}</div>
      <div class="label">High Risk</div>
    </div>
    <div class="stat-card">
      <div class="value" style="color:#fff; background:#9b2c2c; border-radius:6px; padding:2px 8px;" id="stat-critical">{{ summary.critical if summary else 0 }}</div>
      <div class="label">Critical</div>
    </div>
    <div class="stat-card">
      <div class="value" id="stat-time">{{ "%.0f"|format(summary.processing_time_ms) if summary else "—" }}</div>
      <div class="label">Time (ms)</div>
    </div>
  </div>

  <div class="card" id="distribution-bar">
    <h2>Risk Distribution</h2>
    {% set t = summary.total if summary and summary.total else 1 %}
    <div class="progress-bar" style="height:24px; display:flex; border-radius:6px; overflow:hidden;">
      <div id="bar-low" style="background:#c6f6d5; height:100%; width:{{ (summary.low / t * 100) if summary else 0 }}%;" title="Low"></div>
      <div id="bar-medium" style="background:#fefcbf; height:100%; width:{{ (summary.medium / t * 100) if summary else 0 }}%;" title="Medium"></div>
      <div id="bar-high" style="background:#fed7d7; height:100%; width:{{ (summary.high / t * 100) if summary else 0 }}%;" title="High"></div>
      <div id="bar-critical" style="background:#9b2c2c; height:100%; width:{{ (summary.critical / t * 100) if summary else 0 }}%;" title="Critical"></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:#718096;">
      <span id="pct-low">{% if summary %}Low {{ "%.1f"|format(summary.low / t * 100) }}%{% endif %}</span>
      <span id="pct-medium">{% if summary %}Med {{ "%.1f"|format(summary.medium / t * 100) }}%{% endif %}</span>
      <span id="pct-high">{% if summary %}High {{ "%.1f"|format(summary.high / t * 100) }}%{% endif %}</span>
      <span id="pct-critical">{% if summary %}Crit {{ "%.1f"|format(summary.critical / t * 100) }}%{% endif %}</span>
    </div>
  </div>
</div>

<div id="eval-section" style="display:none;">
  <div class="card">
    <h2>Eval Results</h2>
    <p style="margin-bottom:8px; font-size:13px;" id="eval-accuracy"></p>
    <table>
      <thead><tr><th>Policy</th><th>Description</th><th>Expected</th><th>Actual</th><th>Status</th></tr></thead>
      <tbody id="eval-body"></tbody>
    </table>
  </div>
</div>

<div class="card" id="results-section" style="{% if not results %}display:none{% endif %}">
  <h2>Reviews <span style="font-weight:400; font-size:12px; color:#718096;">{{ total_results }} total — page {{ page }}/{{ total_pages }}</span></h2>
  <table>
    <thead>
      <tr><th>Policy #</th><th>Risk</th><th>Flags</th><th>Changes</th><th></th></tr>
    </thead>
    <tbody id="results-body">
      {% for r in results %}
      <tr>
        <td><a href="/ui/review/{{ r.policy_number }}">{{ r.policy_number }}</a></td>
        <td><span class="badge badge-{{ r.risk_level.value }}">{{ r.risk_level.value }}</span></td>
        <td>{{ r.diff.flags|length }}</td>
        <td>{{ r.diff.changes|length }}</td>
        <td><a href="/ui/review/{{ r.policy_number }}" class="btn btn-secondary" style="padding:2px 8px; font-size:11px;">View</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if total_pages > 1 %}
  <div style="display:flex; justify-content:center; align-items:center; gap:12px; margin-top:16px;">
    {% if page > 1 %}
    <a href="/?page={{ page - 1 }}" class="btn btn-secondary" style="padding:4px 12px; font-size:12px;">&larr; Prev</a>
    {% endif %}
    <span style="font-size:13px; color:#4a5568;">{{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
    <a href="/?page={{ page + 1 }}" class="btn btn-secondary" style="padding:4px 12px; font-size:12px;">Next &rarr;</a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function updateStats(s) {
  document.getElementById('stat-total').textContent = s.total;
  document.getElementById('stat-low').textContent = s.low;
  document.getElementById('stat-medium').textContent = s.medium;
  document.getElementById('stat-high').textContent = s.high;
  document.getElementById('stat-critical').textContent = s.critical;
  document.getElementById('stat-time').textContent = Math.round(s.processing_time_ms);
  const t = s.total || 1;
  document.getElementById('bar-low').style.width = (s.low/t*100)+'%';
  document.getElementById('bar-medium').style.width = (s.medium/t*100)+'%';
  document.getElementById('bar-high').style.width = (s.high/t*100)+'%';
  document.getElementById('bar-critical').style.width = (s.critical/t*100)+'%';
  document.getElementById('pct-low').textContent = 'Low '+(s.low/t*100).toFixed(1)+'%';
  document.getElementById('pct-medium').textContent = 'Med '+(s.medium/t*100).toFixed(1)+'%';
  document.getElementById('pct-high').textContent = 'High '+(s.high/t*100).toFixed(1)+'%';
  document.getElementById('pct-critical').textContent = 'Crit '+(s.critical/t*100).toFixed(1)+'%';
  document.getElementById('summary-section').style.display = 'block';
}

async function runBatch(sample) {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('loading-text').textContent = 'Processing...';
  const url = sample ? '/batch/run?sample='+sample : '/batch/run';
  const resp = await fetch(url, {method:'POST'});
  const data = await resp.json();

  if (data.job_id) {
    while (true) {
      await new Promise(r => setTimeout(r, 300));
      const status = await fetch('/batch/status/' + data.job_id).then(r => r.json());
      if (status.status === 'completed') {
        if (status.summary) updateStats(status.summary);
        break;
      }
      if (status.status === 'failed') {
        document.getElementById('loading-text').textContent = 'Failed: ' + (status.error || 'unknown');
        return;
      }
    }
  }

  document.getElementById('loading').style.display = 'none';
  window.location.href = '/?page=1';
}

async function runEval() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('loading-text').textContent = 'Running eval...';
  const resp = await fetch('/eval/run', {method:'POST'});
  const data = await resp.json();
  document.getElementById('loading').style.display = 'none';
  document.getElementById('eval-section').style.display = 'block';
  document.getElementById('eval-accuracy').textContent =
    'Accuracy: ' + data.accuracy + '% (' + data.passed + '/' + data.total + ')';
  const body = document.getElementById('eval-body');
  body.innerHTML = '';
  data.details.forEach(d => {
    const pass = d.risk_pass && d.flags_pass;
    body.innerHTML += '<tr>' +
      '<td>'+d.policy_number+'</td>' +
      '<td>'+d.description+'</td>' +
      '<td><span class="badge badge-'+d.expected_risk+'">'+d.expected_risk+'</span></td>' +
      '<td><span class="badge badge-'+d.actual_risk+'">'+d.actual_risk+'</span></td>' +
      '<td>'+(pass ? '✓' : '✗ '+d.missing_flags.join(', '))+'</td>' +
      '</tr>';
  });
}
</script>
{% endblock %}
